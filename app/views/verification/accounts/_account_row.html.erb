<%
  # Determine background color and status badge based on account state
  if account.needs_secondary_verification
    bg_color = "bg-purple-50"
    status_badge = '<span class="px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700 shrink-0">Needs Secondary Verification</span>'.html_safe
  elsif account.research_status == 'verified'
    bg_color = "bg-green-50"
    status_badge = '<span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700 shrink-0">âœ“ Verified</span>'.html_safe
  elsif account.research_status == 'entered' || account.research_status == 'not_found'
    bg_color = "bg-blue-50"
    status_badge = '<span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700 shrink-0">Needs Verification</span>'.html_safe
  else
    bg_color = "bg-white"
    status_badge = nil
  end

  is_verified = account.research_status == 'verified'
  is_not_started = account.research_status == 'not_started'
  in_edit_mode = false # Will be toggled by JS
%>

<%= turbo_frame_tag "account_#{account.id}" do %>
  <div class="px-5 py-3 <%= bg_color %> transition-colors duration-200" id="account-<%= account.id %>">

    <!-- Display Mode -->
    <div class="flex items-center gap-3" id="display-<%= account.id %>">
      <!-- Platform Icon -->
      <div class="w-7 h-7 rounded-full bg-gray-100 flex items-center justify-center shrink-0">
        <%= platform_icon(account.platform, size: 16) %>
      </div>

      <!-- Platform Name -->
      <div class="w-24 shrink-0 font-medium text-gray-900 text-sm"><%= account.platform %></div>

      <!-- URL or Status Text -->
      <div class="flex-1 text-sm min-w-0">
        <% if is_not_started %>
          <span class="text-gray-400 italic">No data entered</span>
        <% elsif account.research_status == 'not_found' %>
          <span class="text-gray-400 italic">Not found</span>
          <% if account.previous_url.present? %>
            <span class="ml-2 text-xs text-gray-400">Previous: <%= account.previous_url %></span>
            <%= button_to "Restore", mark_entered_verification_account_path(account, url: account.previous_url), method: :patch, class: "ml-1 text-xs text-blue-600 hover:text-blue-800 inline", form: { style: "display: inline;" } %>
          <% end %>
        <% elsif account.url.present? %>
          <a href="<%= account.url %>" target="_blank" class="text-blue-600 hover:text-blue-800 truncate block"><%= account.url %></a>
        <% else %>
          <span class="text-gray-400 italic">No URL</span>
        <% end %>
      </div>

      <!-- Status Badge -->
      <% if status_badge %>
        <%= status_badge %>
      <% end %>

      <!-- Action Buttons (only show when assignment is in progress) -->
      <% if @assignment.in_progress? %>
        <div class="flex items-center gap-2 shrink-0">
          <!-- Verify Button (checkmark icon) -->
          <% if !is_verified %>
            <%= button_to verify_verification_account_path(account), method: :patch, class: "p-1.5 rounded hover:bg-green-100 text-green-600 hover:text-green-700 transition-colors group relative", title: "Verify as accurate" do %>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              <span class="absolute bottom-full right-0 mb-1 px-2 py-1 text-xs bg-gray-900 text-white rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">Verify as accurate</span>
            <% end %>
          <% else %>
            <%= button_to unverify_verification_account_path(account), method: :patch, class: "p-1.5 rounded hover:bg-orange-100 text-orange-600 hover:text-orange-700 transition-colors group relative", title: "Unverify to edit", data: { confirm: "Unverify this account to make changes?" } do %>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
              </svg>
              <span class="absolute bottom-full right-0 mb-1 px-2 py-1 text-xs bg-gray-900 text-white rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">Unverify to edit</span>
            <% end %>
          <% end %>

          <!-- Edit Button -->
          <% if is_verified %>
            <button type="button" disabled class="px-3 py-1 text-xs text-gray-400 bg-gray-100 rounded-md cursor-not-allowed group relative" title="Cannot edit verified account">
              Edit
              <span class="absolute bottom-full right-0 mb-1 px-2 py-1 text-xs bg-gray-900 text-white rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">Unverify first to edit</span>
            </button>
          <% elsif is_not_started %>
            <button type="button" onclick="toggleEdit(<%= account.id %>)" class="px-3 py-1 bg-blue-600 text-white text-xs rounded-md hover:bg-blue-700 transition-colors">Add Data</button>
          <% else %>
            <button type="button" onclick="toggleEdit(<%= account.id %>)" class="px-3 py-1 text-purple-600 hover:bg-purple-50 text-xs rounded-md transition-colors">Edit</button>
          <% end %>

          <!-- Not Found Button (only when not started or in edit mode) -->
          <% if is_not_started %>
            <%= button_to "Not Found", mark_not_found_verification_account_path(account), method: :patch, class: "px-3 py-1 bg-gray-200 text-gray-700 text-xs rounded-md hover:bg-gray-300 transition-colors", data: { confirm: "Mark this account as not found?" } %>
          <% end %>

          <!-- Notes Button -->
          <button type="button" onclick="openNotesModal(<%= account.id %>, '<%= j account.platform %>')" class="p-1.5 rounded hover:bg-gray-100 transition-colors group relative" title="<%= account.research_notes.present? ? 'Edit notes' : 'Add notes' %>">
            <svg data-notes-icon class="w-4 h-4 <%= account.research_notes.present? ? 'text-blue-600' : 'text-gray-300 hover:text-gray-500' %>" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/></svg>
            <span class="absolute bottom-full right-0 mb-1 px-2 py-1 text-xs bg-gray-900 text-white rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"><%= account.research_notes.present? ? 'Edit notes' : 'Add notes' %></span>
          </button>
        </div>
      <% end %>
    </div>

    <!-- Edit Mode (hidden by default) -->
    <div class="hidden mt-3" id="edit-<%= account.id %>">
      <div class="flex items-center gap-3">
        <!-- Platform Icon (stays visible) -->
        <div class="w-7 h-7 rounded-full bg-gray-100 flex items-center justify-center shrink-0">
          <%= platform_icon(account.platform, size: 16) %>
        </div>

        <!-- Platform Name (stays visible) -->
        <div class="w-24 shrink-0 font-medium text-gray-900 text-sm"><%= account.platform %></div>

        <!-- Edit Form -->
        <%= form_with url: mark_entered_verification_account_path(account), method: :patch, class: "flex items-center gap-2 flex-1" do %>
          <input type="url" name="url" value="<%= account.url %>" placeholder="https://..." class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
          <button type="submit" class="px-4 py-1.5 bg-purple-600 text-white text-sm rounded-md hover:bg-purple-700 transition-colors shrink-0">Save</button>
          <button type="button" onclick="toggleEdit(<%= account.id %>)" class="px-4 py-1.5 text-gray-600 hover:bg-gray-100 text-sm rounded-md transition-colors shrink-0">Cancel</button>
          <%= button_to "Mark Not Found", mark_not_found_verification_account_path(account), method: :patch, class: "px-3 py-1.5 text-red-600 hover:bg-red-50 text-sm rounded-md transition-colors shrink-0", data: { confirm: "Mark as not found?" } %>
        <% end %>
      </div>
    </div>

  </div>
<% end %>
