<div class="min-h-screen bg-gray-50 p-8">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">ECharts Test Page</h1>

    <!-- Test 1: Simple Bar Chart -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 mb-8">
      <h2 class="text-xl font-semibold mb-4">Test 1: Simple Bar Chart</h2>
      <div id="test-bar-chart" style="width: 100%; height: 400px;"></div>
    </div>

    <!-- Test 2: US Map (Simple) -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 mb-8">
      <h2 class="text-xl font-semibold mb-4">Test 2: US Map (Basic)</h2>
      <div id="test-map-basic" style="width: 100%; height: 500px;"></div>
    </div>

    <!-- Test 3: US Map (With Our Data) -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
      <h2 class="text-xl font-semibold mb-4">Test 3: US Map (With Election Data)</h2>
      <div id="test-map-data" style="width: 100%; height: 500px;"></div>
    </div>
  </div>
</div>

<!-- Load ECharts and D3 for projection -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-array@2.8.0/dist/d3-array.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-geo@2.0.1/dist/d3-geo.min.js"></script>

<script>
  // Test 1: Simple Bar Chart
  (function() {
    const chartDom = document.getElementById('test-bar-chart');
    if (!chartDom) {
      console.error('Bar chart container not found');
      return;
    }

    if (typeof echarts === 'undefined') {
      console.error('ECharts not loaded');
      chartDom.innerHTML = '<p class="text-red-600">Error: ECharts library failed to load</p>';
      return;
    }

    const myChart = echarts.init(chartDom);
    const option = {
      title: {
        text: 'Simple Bar Chart Test'
      },
      tooltip: {},
      xAxis: {
        data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
      },
      yAxis: {},
      series: [{
        name: 'Sales',
        type: 'bar',
        data: [5, 20, 36, 10, 10, 20, 15]
      }]
    };
    myChart.setOption(option);
    console.log('Bar chart initialized successfully');
  })();

  // Test 2: US Map (Basic)
  (function() {
    const chartDom = document.getElementById('test-map-basic');
    if (!chartDom) {
      console.error('Map basic container not found');
      return;
    }

    if (typeof echarts === 'undefined') {
      console.error('ECharts not loaded');
      return;
    }

    console.log('Loading USA map data...');
    // Use ECharts USA GeoJSON with d3 Albers projection
    fetch('https://raw.githubusercontent.com/apache/echarts-website/asf-site/examples/data/asset/geo/USA.json')
      .then(response => {
        console.log('Map data response:', response.status);
        return response.json();
      })
      .then(usaJson => {
        console.log('USA GeoJSON loaded:', usaJson);

        // Create Albers USA projection
        const projection = d3.geoAlbersUsa();

        // Register map
        echarts.registerMap('USA', usaJson);

        const myChart = echarts.init(chartDom);
        const option = {
          title: {
            text: 'Basic US Map',
            left: 'center'
          },
          tooltip: {
            trigger: 'item'
          },
          series: [{
            type: 'map',
            map: 'USA',
            roam: true,
            projection: {
              project: function (point) {
                return projection(point);
              },
              unproject: function (point) {
                return projection.invert(point);
              }
            },
            itemStyle: {
              areaColor: '#94a3b8',
              borderColor: '#1e293b'
            },
            emphasis: {
              itemStyle: {
                areaColor: '#4f46e5'
              }
            }
          }]
        };
        myChart.setOption(option);
        console.log('Basic map initialized successfully');
      })
      .catch(err => {
        console.error('Failed to load USA map:', err);
        chartDom.innerHTML = '<p class="text-red-600">Error loading map: ' + err.message + '</p>';
      });
  })();

  // Test 3: US Map (With Election Data)
  (function() {
    const chartDom = document.getElementById('test-map-data');
    if (!chartDom) {
      console.error('Map data container not found');
      return;
    }

    const stateElections = <%= raw @state_elections_data.to_json %>;
    console.log('State elections data:', stateElections);

    const STATE_NAME_TO_CODE = {
      "Alabama": "AL", "Alaska": "AK", "Arizona": "AZ", "Arkansas": "AR",
      "California": "CA", "Colorado": "CO", "Connecticut": "CT", "Delaware": "DE",
      "Florida": "FL", "Georgia": "GA", "Hawaii": "HI", "Idaho": "ID",
      "Illinois": "IL", "Indiana": "IN", "Iowa": "IA", "Kansas": "KS",
      "Kentucky": "KY", "Louisiana": "LA", "Maine": "ME", "Maryland": "MD",
      "Massachusetts": "MA", "Michigan": "MI", "Minnesota": "MN", "Mississippi": "MS",
      "Missouri": "MO", "Montana": "MT", "Nebraska": "NE", "Nevada": "NV",
      "New Hampshire": "NH", "New Jersey": "NJ", "New Mexico": "NM", "New York": "NY",
      "North Carolina": "NC", "North Dakota": "ND", "Ohio": "OH", "Oklahoma": "OK",
      "Oregon": "OR", "Pennsylvania": "PA", "Rhode Island": "RI", "South Carolina": "SC",
      "South Dakota": "SD", "Tennessee": "TN", "Texas": "TX", "Utah": "UT",
      "Vermont": "VT", "Virginia": "VA", "Washington": "WA", "West Virginia": "WV",
      "Wisconsin": "WI", "Wyoming": "WY"
    };

    // Use ECharts USA GeoJSON with d3 projection
    fetch('https://raw.githubusercontent.com/apache/echarts-website/asf-site/examples/data/asset/geo/USA.json')
      .then(response => response.json())
      .then(usaJson => {
        console.log('USA GeoJSON loaded for election map');

        // Create Albers USA projection
        const projection = d3.geoAlbersUsa();

        // Register map
        echarts.registerMap('USA', usaJson);

        const mapData = Object.keys(STATE_NAME_TO_CODE).map(stateName => {
          const code = STATE_NAME_TO_CODE[stateName];
          const election = stateElections[code];
          const hasContests = election && election.contest_count > 0;

          return {
            name: stateName,
            value: hasContests ? 2 : 1,
            code: code,
            election: election,
            itemStyle: {
              areaColor: hasContests ? '#4f46e5' : '#94a3b8'
            },
            emphasis: {
              itemStyle: {
                areaColor: '#ffffff'
              }
            }
          };
        });

        console.log('Map data prepared, states with contests:',
          mapData.filter(d => d.value === 2).map(d => d.code));

        const myChart = echarts.init(chartDom);
        const option = {
          title: {
            text: '2026 Primary Elections',
            left: 'center'
          },
          tooltip: {
            trigger: 'item',
            formatter: function(params) {
              if (!params.data) return '';

              const code = params.data.code;
              const election = params.data.election;

              let html = '<strong>' + params.name + ' (' + code + ')</strong><br/>';

              if (election) {
                if (election.date) {
                  const date = new Date(election.date);
                  html += 'Election: ' + date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + '<br/>';
                }
                if (election.registration_deadline) {
                  const deadline = new Date(election.registration_deadline);
                  html += 'Registration: ' + deadline.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + '<br/>';
                }
                if (election.contest_count > 0) {
                  html += 'Contests: ' + election.contest_count;
                } else {
                  html += 'No contest data yet';
                }
              } else {
                html += 'No election data';
              }

              return html;
            }
          },
          series: [{
            type: 'map',
            map: 'USA',
            roam: true,
            projection: {
              project: function (point) {
                return projection(point);
              },
              unproject: function (point) {
                return projection.invert(point);
              }
            },
            emphasis: {
              label: {
                show: false
              }
            },
            itemStyle: {
              borderColor: '#1e293b',
              borderWidth: 1
            },
            data: mapData
          }]
        };

        myChart.setOption(option);
        console.log('Election map initialized successfully');

        myChart.on('click', function(params) {
          if (params.data && params.data.code) {
            console.log('Clicked state:', params.data.code);
            window.location.href = '/ballots?year=2026&state=' + params.data.code;
          }
        });
      })
      .catch(err => {
        console.error('Failed to load USA map:', err);
        chartDom.innerHTML = '<p class="text-red-600">Error loading map: ' + err.message + '</p>';
      });
  })();
</script>
